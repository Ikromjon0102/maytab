<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <title>Smart Agent Sozlamalari</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f6f9;
        }

        .card {
            border: none;
            shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="p-4">
    <div class="container" style="max-width: 800px;">
        <div class="card p-4">
            <h3 class="text-primary mb-4">üñ•Ô∏è Smart School Agent</h3>

            <div class="mb-3">
                <label class="form-label fw-bold">Cloud Server URL</label>
                <input type="text" id="cloud_url" class="form-control" value="{{ config.cloud_url }}"
                    placeholder="http://85.112.xx.xx/api/upload-logs/">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Maktab API Kaliti (UUID)</label>
                <input type="text" id="school_key" class="form-control" value="{{ config.school_key }}">
            </div>

            <h5 class="mt-4 border-bottom pb-2">Terminallar</h5>
            <div id="terminals_list">
            </div>
            <button class="btn btn-outline-primary btn-sm mt-2" onclick="addTerminal()">+ Terminal qo'shish</button>

            <div class="d-grid mt-5">
                <button class="btn btn-success btn-lg" onclick="saveConfig()">SAQLASH VA ISHLATISH</button>
            </div>
        </div>
    </div>

    <script>
        let terminals = {{ config.terminals | tojson }};

        function renderTerminals() {
            const container = document.getElementById('terminals_list');
            container.innerHTML = '';
            terminals.forEach((term, index) => {
                container.innerHTML += `
                    <div class="row g-2 mb-2 align-items-center bg-light p-2 rounded">
                        <div class="col-md-3"><input type="text" class="form-control form-control-sm" placeholder="Nomi" value="${term.name}" onchange="updateTerm(${index}, 'name', this.value)"></div>
                        <div class="col-md-3"><input type="text" class="form-control form-control-sm" placeholder="IP" value="${term.ip}" onchange="updateTerm(${index}, 'ip', this.value)"></div>
                        <div class="col-md-2"><input type="text" class="form-control form-control-sm" placeholder="User" value="${term.user}" onchange="updateTerm(${index}, 'user', this.value)"></div>
                        <div class="col-md-2"><input type="password" class="form-control form-control-sm" placeholder="Pass" value="${term.pass}" onchange="updateTerm(${index}, 'pass', this.value)"></div>
                        <div class="col-md-1"><button class="btn btn-danger btn-sm" onclick="removeTerm(${index})">X</button></div>
                    </div>
                `;
            });
        }

        function addTerminal() {
            terminals.push({ name: "", ip: "192.168.1.64", user: "admin", pass: "" });
            renderTerminals();
        }

        function removeTerm(index) {
            terminals.splice(index, 1);
            renderTerminals();
        }

        function updateTerm(index, field, value) {
            terminals[index][field] = value;
        }

        async function saveConfig() {
            const data = {
                cloud_url: document.getElementById('cloud_url').value,
                school_key: document.getElementById('school_key').value,
                terminals: terminals
            };
            const res = await fetch('/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            alert(result.message);
        }

        renderTerminals();
    </script>
</body>

</html>